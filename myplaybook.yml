---

- hosts: localhost

  tasks:
  - name: Provision ec2
    delegate_to: localhost
    block:
    - name: Create key pair
      amazon.aws.ec2_key:
        name: "ansible_keys"
        region: ap-south-1
        aws_access_key: "{{ ec2_access_key }}"
        aws_secret_key: "{{ ec2_secret_key }}"
        key_material: "{{ item }}"
      with_file: ~/.ssh/ansible-keys.pub

    - name: Create EC2 instances
      amazon.aws.ec2_instance:
        name: "public-compute-instance"
        key_name: "ansible_keys"
        instance_type: t2.micro
        region: ap-south-1
        aws_access_key: "{{ ec2_access_key }}"
        aws_secret_key: "{{ ec2_secret_key }}"
        security_group: default
        network:
          assign_public_ip: true
        image_id: "ami-0e1d06225679bc1c5"

    - name: Get instance details
      ec2_instance_info:
        aws_access_key: "{{ ec2_access_key }}"
        aws_secret_key: "{{ ec2_secret_key }}"
        region: ap-south-1
      register: result

  - name: Install and configure httpd server
    delegate_to: "{{ result.instances[0].public_dns_name }}"
    become: true
    block:
    - name: Install httpd server
      yum:
        pkg: httpd
        state: latest
        use_backend: yum4
    - name: Copy index.html
      copy:
        src: index.html
        dest: /var/www/html/index.html
        owner: apache
        group: apache
        mode: 0644

    - name: Enable httpd on restart
      service:
        name: httpd
        enabled: yes
      notify: restart httpd

  handlers:
    - name: restart httpd
      service:
        name: httpd
        state: restarted






